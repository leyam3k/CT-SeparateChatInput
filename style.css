/*
  CT-SeparateChatInput
  Separates the chat input into a dedicated row above the control buttons.
*/

/* --- Main Layout --- */

/* Enable wrapping on the form container */
#send_form.ct-separate-chat-input {
  flex-wrap: wrap !important;
  align-content: center;
  justify-content: center;
}

/* Force the textarea to take the full top row */
#send_form.ct-separate-chat-input > #send_textarea {
  flex-basis: 100% !important;
  width: 100% !important;
  max-width: 100% !important;

  /* Ensure it is visually first */
  order: -9999 !important;

  /* Spacing between input and buttons */
  margin-left: 0 !important;
  margin-right: 0 !important;
  margin-bottom: 5px;
}

/* --- Control Bar --- */

/* The new container for all buttons */
#ct-sci-control-bar {
  display: flex;
  flex-basis: 100%;
  width: 100%;
  justify-content: center; /* Center buttons by default */
  align-items: center;
  flex-wrap: wrap;
  gap: 0px; /* Spacing between buttons */
  position: relative;

  /* Ensure it sits below textarea */
  order: 0;

  height: 35px; /* Fix for Quick Persona Overflow */
}

/* Styles for buttons inside our bar */
#ct-sci-control-bar > .interactable,
#ct-sci-control-bar > .menu_button,
#ct-sci-control-bar > div[tabindex] {
  margin: 2px !important; /* Reset inherited margins */
  position: relative;
}

/* 
   Fixed Positioning Logic 
   We want Options on far Left and Send on far Right.
   We achieve this by making the control bar justify-content: space-between
   BUT we also want the middle buttons centered.
   
   A trick is to use auto margins if we are in a flex container.
*/

/* Fixed Left Button (Options) */
#ct-sci-control-bar > #options_button.ct-sci-fixed-button {
  margin-right: auto !important; /* Pushes everything else to the right */
  order: -9999 !important;
  /* Add little space on the corner */
  margin-left: 5px !important;
}

/* Right Group (Send & Alternates) */
#ct-sci-right-group {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  margin-left: auto !important; /* Pushes itself to the far right */
  margin-right: 5px !important;
  order: 9999 !important;
}

#ct-sci-right-group > div {
  /* Styles for buttons inside the right group (send, stop, etc) */
  /* Ensure they are visible and sized correctly */
  position: relative;
  /* Reset margins for children */
  margin: 0 !important;
}

/* Ensure font-awesome icons are centered and sized */
#ct-sci-right-group .fa-solid,
#ct-sci-right-group .fa-fw {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 30px; /* Standard button width */
  height: 30px; /* Standard button height */
}

/* Fix for small icons and cursor interactivity */
#extensionsMenuButton,
#options_button,
#send_but {
  font-size: 1.1em; /* Make icon a bit bigger if needed */
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer; /* Ensure pointer cursor on hover */
}

/* Ensure all dynamic buttons have consistent size */
#ct-sci-control-bar > .ct-sci-dynamic-button {
  width: 30px;
  height: 30px;
  min-width: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
}

#quickPersonaImg {
    width: 90% !important;
    height: 90% !important;
}

/* Ensure all interactive buttons have pointer cursor and hover effects */
#ct-sci-control-bar .interactable,
#ct-sci-control-bar .menu_button,
#ct-sci-control-bar .fa-solid,
#ct-sci-right-group .fa-solid {
  cursor: pointer;
  transition:
    opacity 0.2s,
    color 0.2s,
    text-shadow 0.2s;
  opacity: 0.7 !important;
}

#ct-sci-control-bar .interactable:hover,
#ct-sci-control-bar .menu_button:hover,
#ct-sci-control-bar .fa-solid:hover,
#ct-sci-right-group .fa-solid:hover {
  opacity: 1 !important;
  text-shadow: 0 0 5px var(--SmartThemeBlurTintColor);
}

/*
   Hide script buttons by default.
   ST normally manages their visibility via inline styles or parent-scoped CSS.
   Since we moved them, we need to ensure they are hidden until ST explicitly shows them (via inline style).
*/
#ct-sci-right-group .stscript_btn {
  display: none;
}

/* Dynamic Buttons (Middle) */
#ct-sci-control-bar > .ct-sci-dynamic-button {
  /* Default spacing */
  margin: 0 5px !important;
}

/* Hide the original containers if they become empty to prevent layout shifts */
#leftSendForm:empty,
#rightSendForm:empty,
#nonQRFormItems:empty {
  display: none !important;
}

/* --- Top Bar Hider --- */

/* The button itself - position is dynamically set by JS to align with placeholder */
#topBarHiderButton {
  position: fixed;
  /* Position properties (left, top, bottom, transform) are set dynamically by JavaScript
     to bind with #ct-sci-placeholder position. No hardcoded values needed. */
  width: 25px;
  height: 25px;
  border: none;
  border-radius: 50%;
  background-color: rgba(128, 128, 128, 0.5);
  font-size: 1.1em;
  cursor: pointer;
  z-index: 2147483647; /* Max Z-Index to stay on top of everything */
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
  transition:
    opacity 0.3s,
    background-color 0.3s,
    box-shadow 0.3s,
    display 0.2s;
  /* Note: We exclude left/top from transition to avoid laggy position updates */
  line-height: 25px;
  opacity: 0.5;

  display: flex;
  align-items: center;
  justify-content: center;
  margin-top: 3px;

  color: white;
  backdrop-filter: blur(4px);
  
  /* Prevent selection and touch delays on mobile */
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
  touch-action: manipulation;
}

/* Placeholder - acts as the position anchor for the floating button */
#ct-sci-placeholder {
  width: 30px;
  height: 30px;
  min-width: 30px;
  display: inline-block;
  opacity: 0;
  pointer-events: none;
  flex-shrink: 0;
  /* Ensure it maintains its space even when keyboard shows */
  position: relative;
}

#topBarHiderButton:hover {
  opacity: 1;
  background-color: rgba(128, 128, 128, 0.9);
}

/* Hiding Logic */
body.st-top-bar-hidden {
  --topBarBlockSize: 0px !important;
}

body.st-top-bar-hidden #top-bar,
body.st-top-bar-hidden #top-settings-holder > *:not(#stcd--qrDrawer) {
  display: none !important;
}

/* Hide drawer icon when hidden */
body.st-top-bar-hidden
  #stcd--qrDrawer:has(#stcd--drawer)
  .stcd--hasPoster
  .drawer-icon::before {
  display: none !important;
}

/* --- Mobile-specific adjustments --- */
@media (max-width: 768px), (orientation: portrait) {
  /* Ensure button stays visible on mobile */
  #topBarHiderButton {
    /* Slightly bigger for easier touch */
    width: 25px;
    height: 25px;
    font-size: 1.2em;
  }
  
  /* Control bar adjustments for mobile keyboards */
  #ct-sci-control-bar {
    /* Ensure control bar stays visible when keyboard opens */
    position: relative;
    z-index: 1000;
  }
  
  /* Prevent viewport shifts when keyboard opens */
  #send_form.ct-separate-chat-input {
    /* Keep form structure stable */
    min-height: auto;
  }
}

/* Handle virtual keyboard specifically */
@supports (height: 100vh) and (height: 100dvh) {
  /* Use dynamic viewport height for better keyboard handling */
  @media (max-width: 768px) {
    #send_form.ct-separate-chat-input {
      /* Use dynamic viewport units if supported */
      max-height: calc(100dvh - var(--topBarBlockSize, 0px));
    }
  }
}
